

{% extends "dups/base.html" %}

{% block sidebar %}
	<ul class="sidebar-nav">
		Master Archive Folder:
		{% if page.masterpath %}
		
		<form action="/dups/folder/{{path}}" method ="post" id="master-folder-form">
		{% csrf_token %}
		<p>
			<div class="master-url">
			<a href="{{page.masterpath_url}}">{{page.masterpath}}</a>
			</div>
		<p>
		<p>
		<button type="submit" name="masterscan"> Scan Master</button>
    <p><p>
		</form>
		{% endif %} 
		
		<p><p><p><p>
			<form action="/dups/folder/{{path}}" method ="post" name="scan-folder-form" id="scan-folder-form">
			{% csrf_token %}
			Scan Folder:
			<div class="local-url">
			<a href="/dups/folder/{{page.scanpath}}">{{page.scanpath}}</a>
			</div>
			{% if not page.inside_master %}
					 <input type="hidden" id="local-path" name="local-path" value="{{page.scanpath}}">
  					<button type="submit" name="scan" class="btn btn-sm btn-success">Scan Folder</button>
			{% endif %} 
			</form>
	</ul>
{% endblock %}

{% block body_content %}

{% if page.inside_master %}
<div style="color:white;background-color:red">INSIDE MASTER ARCHIVE </div>
{% endif %}
<div class='nav-container'>		
		<ol class="breadcrumb bread1" id="{{path}}">
		  <li><a href="/dups">Home</a></li>
		{% for fullpath,relpath,basename,hash in tags %}  
		  <li><a href="/dups/folder/{{fullpath}}">{{basename}}</a></li>
		{% endfor %} 
		</ol>

</div>
 		
				<div class="menu" id="foo" data-id="somepath">
		  		<span class="menu-path"></span>
		  		<p><span class="menu-hash">somehash</span>
 		  			<span class="menu-size">somehash</span>
 		  			<span class="menu-scans">info</span>
 		  			<span class="menu-localscans">info</span>
		  		<ul class="menu-options">
		    		<li class="menu-option scan-folder"><u>Set as Scan Folder</u></li>
		    		<li class="menu-option master-folder"><u>Set as Master Folder</u></li>
		  		</ul>
				</div>	
	
		<p>

		<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
		  <div class="panel panel-default">
				<ul>
				{% if not subfiles%}
				Empty folder
				{% endif %}
				{% for f in subfiles %}
				{{ f }}
				{% endfor %}
				</ul>	
			</div>
		</div>
{% endblock %}


{% block javascript %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

<script>

$('.flip').click(function(e) {
//    alert('clicked this')
    var $this = $(this);
    $this.next('div.subdir').slideToggle('fast');
    $this.toggleClass('show');
    if ($this.hasClass('show')) {
        $this.html('<span style="font-size:12px">[hide}</span>');
    } else {
        $this.html(' +');
			};

		});

const menu = document.querySelector(".menu");

let menuVisible = false;
let clicked=false

menu.style.display="none"

const toggleMenu = command => {
//  var menu=document.getElementById('foo')
  menu.style.display = command === "show" ? "block" : "none";
  menuVisible = !menuVisible;
};

const setPosition = ({ top, left }) => {
//  console.log(left)
//  console.log(`${top}px`)
  menu.style.left = `${left-30}px`;
  menu.style.top = `${top-80}px`;
  toggleMenu('show');
};

const folderActions = (clicked) => 
 {
	clicked.style.fontWeight="bold";
	var item_id = clicked.id;
	
	$(".menu-path").html("<b>Folder:</b> "+clicked.id);
	$(".menu").attr("data-id",clicked.id);
	$(".scan-folder").show();
	$(".master-folder").show();
	$(".menu-hash").hide();
	$(".menu-size").hide();
	$(".menu-scans").hide();	
	$(".menu-localscans").hide();	
	var rect = clicked.getBoundingClientRect();

  const origin = {
  	left: rect.left,
  	top: rect.top+window.scrollY
  };
    setPosition(origin);
    event.preventDefault();
    menuVisible = true;
 };


//file right-click menu
$('.du').contextmenu(function(event)
	{
	if(clicked){
    clicked.style.fontWeight="normal"; //clear previous highlight
		};
  clicked=this
  var item_id = this.id;
  var hash_id= $(this).attr('src');
  var size=$(this).attr('size');
  $(".menu-hash").html('<b>Hash:</b>...'+hash_id.substring(50));
	this.style.fontWeight="bold";
	$(".menu-path").html("<b>File:</b> "+this.id);
	$(".menu-size").html("<b>Size:</b> "+size);
	$(".menu-scans").html('<p><b>MASTER</b>: Scanned: '+$(this).attr('master_scan')+' Changed:'+$(this).attr('master_changed')+' Dups: '+$(this).attr('m_dup')+' ('+$(this).attr('m_dups')+')');	
	$(".menu-localscans").html('<p><b>SCAN FOLDER</b>: Scanned: '+$(this).attr('local_scan')+' Duplicate: '+$(this).attr('l_dup')+' Changed:'+$(this).attr('local_changed')+' Dups:'+$(this).attr('l_dup')+' ('+$(this).attr('l_dups')+')'+' Found in Master: '+$(this).attr('hash_in_master'));	
	$(".scan-folder").hide();
	$(".master-folder").hide();
	var rect = this.getBoundingClientRect();
  event.preventDefault();
  event.stopPropagation();
//  alert('context');
  const origin = {
  	left: rect.left,
  	top: rect.top+window.scrollY
  };
    setPosition(origin);
    menuVisible = true;
  });

$('.bread1').contextmenu(function(event)
	{
	
	if(clicked){
    clicked.style.fontWeight="normal"; //clear previous highlight
		};
	clicked=this;
	folderActions(clicked);
	});

//folder right-click menu
$('.subfolder').contextmenu(function(event)
	{
	if(clicked){
    clicked.style.fontWeight="normal"; //clear previous highlight
		};
  clicked=this;
  folderActions(clicked);
  event.stopPropagation();
  });

	
//folder right-click menu
$('.folder-item').contextmenu(function(event)
	{
	if(clicked){
    clicked.style.fontWeight="normal"; //clear previous highlight
		};
  clicked=this;
  folderActions(clicked);
  });

$(".master-folder").click(
  function() {
  var folder = $(this).closest("div[data-id]").attr('data-id');
  $(".master-url").html("<a href='/dups/folder/"+folder+"'>"+folder+"</a>");
  var dataform=$('#master-folder-form').serialize();
  dataform=dataform+"&folder_type=master&folder_path="+folder
  //alert(dataform)
  $.post( '/dups/ajax',dataform, function(data)
  	{
  	if (data.saved==false)
  		{
  		console.log(data.message);
  		alert('Failed to save');
  		}
  	else
  		{
  		document.getElementById("form-errors-{{filter}}").innerHTML='';
  		};
  	},'json' // I expect a JSON response
  	);
});

$(".scan-folder").click(
  function() {
  var folder = $(this).closest("div[data-id]").attr('data-id');
  $(".local-url").html("<a href='/dups/folder/"+folder+"'>"+folder+"</a>");
  var dataform=$('#scan-folder-form').serialize();
  dataform=dataform+"&folder_type=local&folder_path="+folder
  //alert(dataform)
  $.post( '/dups/ajax',dataform, function(data)
  	{
  	if (data.saved==false)
  		{
  		//console.log(data.message);
  		alert('Failed to save');
  		}
  	else
  		{
  		document.getElementById("form-errors-{{filter}}").innerHTML='';
  		};
  	},'json' // I expect a JSON response
  	);
});

window.addEventListener("click", e => {
  if(menuVisible)
  {
  	toggleMenu("hide");
  	if(clicked){
    clicked.style.color="black";
		};
	}
});


</script>


<style>
	
.nav-container {
  position:relative;
}
.bread-button {
  position:absolute;
  right:1rem;
  top:50%;
  transform:translateY(-100%);
}
.minitext {
  font-size:50%;	
}
.sizetext {
  font-size:80%;
  color:blue;	
}

.topmenu{
color:red	
}

.menu {
  width: 400px;
  box-shadow: 0 4px 5px 3px rgba(0, 0, 0, 0.2);
  position: absolute;
  display: hide;
  color: black;
  background: #e3e9f2;
  opacity: 1;
  
  .menu-options {
    list-style: none;
    padding: 10px 0;

    .menu-option {
      font-weight: 500;
      font-size: 14px;
      padding: 10px 40px 10px 20px;
      cursor: pointer;

      &:hover {
        background: rgba(0, 0, 0, 0.2);
      }
    }
  }
}

	
</style>

{% endblock %}

